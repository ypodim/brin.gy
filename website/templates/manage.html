{% extends "base.html" %}

{% block head %}
{% autoescape None %}
<script language="javascript" type="text/javascript">

///////////////////////////////////
//////        START SUGGESTION BOX

suggestion_box = {};
suggestion_box.data = {};

suggestion_box.fetch_data = function(key, val, obj)
{
    val = val.toLowerCase();
    
    $.getJSON(E.satellite.url+"/profile/complete/"+key+"/"+val, function(json){
        suggestion_box.data = {};
        for (i in json.matches) {
            val = json.matches[i][0];
            card = json.matches[i][1];
            suggestion_box.data[val] = card;
        }
        suggestion_box.show_suggestions(obj);
    });
};

suggestion_box.show_suggestions = function(obj)
{   
    if( ! $("#dropdown").length ) {
        offset = obj.offset();
        _top = offset.top + obj.height() + 10;
        _left = offset.left;
        width = 100;
        
        css = {top:_top, left:_left, border:"1px solid #dddddd", backgroundColor:"white"};
        dropdown = $("<div id='dropdown'></div>").css(css).addClass("flying medium");
        $("body").append(dropdown);
    }
    
    $("#dropdown").empty();
    
    for (sug in suggestion_box.data) {
        val = $("<a></a>").html(sug).attr("sug",sug).addClass("suggestionVal");
        val.click(function(){
            obj.val($(this).attr("sug"));
            obj.trigger("keydown", [{obj:{keyCode:13}}]);
            return false;
        });
        card = $("<span></span>").html(suggestion_box.data[sug]).addClass("label suggestionCard");
        entry = $("<div></div>").addClass("suggestionEntry");
        entry.append(val).append(card);
        $("#dropdown").append(entry);
    }
};

suggestion_box.hide_suggestions = function(obj)
{
//     console.log( "closing" );
    $("#dropdown").remove();
};


Object.size = function(obj) {
    var size = 0, key;
    for (key in obj) {
        if (obj.hasOwnProperty(key)) size++;
    }
    return size;
};

if (typeof String.prototype.startsWith != 'function') {
  String.prototype.startsWith = function (str){
    return this.indexOf(str) == 0;
  };
}

//////        END SUGGESTION BOX
////////////////////////////////



// sdata example:
// profile = {
//      languages: {
//              selected: false,
//              display: true,
//              cnt: 109,
//              matches: {},
//              values: {
//                      greek: {
//                              cnt: 9,
//                              haveit: true,
//                              selected: false,
//                              display: true,
//                              matches: {},
//                              visited: false,
//                      },
//              },
//      },
// }

attr_manager = {};
attr_manager.cache = {};
attr_manager.sdata = {
    
    location:{
        "my location":{cnt:0, values:{}, selected:0, display:true, matches:{}},
//         "destination":{},
    },
    profile:{},
//     buysell:{
//         "product":{},
//     },
};

attr_manager.add_sdata = function(cap, key, cnt) {
    if (cap==undefined || key==undefined || cnt==undefined){
        console.log("*** add_sdata: undefined var:", cap, key, cnt);
        return;
    }
    if (attr_manager.sdata[cap] == undefined)
        attr_manager.sdata[cap] = {};
    
    attr_manager.sdata[cap][key] = {cnt:0, values:{}, selected:0, display:true, matches:{}};
}

attr_manager.hide_keyvals = function(){
    for (cap in this.sdata) {
        for (key in this.sdata[cap]){
            attr_manager.sdata[cap][key].display = false;
            for (val in this.sdata[cap][key].values){
                attr_manager.sdata[cap][key].values[val].display = false;
            }
        }
    }
}

attr_manager.show_keyvals = function(){
    for (cap in this.sdata) {
        for (key in this.sdata[cap]){
            attr_manager.sdata[cap][key].display = true;
            for (val in this.sdata[cap][key].values){
                attr_manager.sdata[cap][key].values[val].display = true;
            }
        }
    }
}

attr_manager.deselect_keyvals = function(){
    for (cap in this.sdata) {
        for (key in this.sdata[cap]){
            attr_manager.sdata[cap][key].selected = false;
            for (val in this.sdata[cap][key].values){
                attr_manager.sdata[cap][key].values[val].selected = false;
            }
        }
    }
}

attr_manager.get_location = function() {
    for (val in attr_manager.sdata.location["my location"].values)
        if (attr_manager.sdata.location["my location"].values[val].haveit)
            return val;
    return null;
}

E.monitor = {
    "user_matches":{
        "by_keyval": {},
        "intersection": [],
    },
};

E.previous_intersection = {};
// holds the first list of intersected agents among two consecutive
// intersection polls, so that the intersection and difference between
// the consecutive lists can be found fast and have the results list 
// change accordingly without resetting the whole list.

E.satellite = {};
E.satellite.url = "{{config.discov_url}}";
E.agent = {};
E.agent.id = "{{config.agentid}}";
E.agent.baseurl = "{{config.ego_url_prefix}}";
E.agent.url = "{{config.ego_url_prefix}}/{{config.agentid}}";
E.website_url = "{{config.website_url_prefix}}";

E.post_keyval = null;
// save key/val to agent.
E.delete_keyval = null;
// delete key/val to agent

// E.generate_entry = null;
// generates UI profile element. 
// Arguments: key, val (optional for new pairs)

E.set_matches = null;
// animates the counter button of intersected matches to target value

E.populate_attrs = null;
// Show available attributes tab on left pane. Uses values stored in E.monitor 

E.poll_matches = null;
E.fetch_keyvals = null;
// fetch next batch of profiles attributes. 
// Uses E.caps to store fetched attributes.
E.last_fetched = ""; 
// keeps track of the last attribute fetched to continue from the next one

E.formatted_length = 24;

///////////////////////////////////////////////


E.post_visited_keyval = function() {
    data = {};
    for (key in attr_manager.sdata.profile) {
        data[key] = [];
        for (val in attr_manager.sdata.profile[key].values)
            data[key].push(val);
    }
    
    secret = cookies.get_cookie().pseudonyms[E.agent.id];
    if (secret == undefined) {
        console.log("Not allowed to change "+E.agent.id+"'s profile.");
        return {error:"Not allowed to change "+E.agent.id+"'s profile."};
    }
    params = {data:JSON.stringify(data), secret:secret};
    console.log(params);
    
    $.post(E.agent.url+"/profile/visited", params, function(json){
        return json;
    }, "json");
}

E.post_keyval = function(cap, key, val, clb) {
    data = JSON.stringify([[key, val]]);
    if (clb == undefined)
        clb = function(json){
            console.log("post", json);
        }
    
    secret = cookies.get_cookie().pseudonyms[E.agent.id];
    if (secret == undefined) {
        clb({error:"Not allowed to change "+E.agent.id+"'s profile."});
        return false;
    }
    $.post(E.agent.url+"/"+cap, {data:data, secret:secret}, function(json){
        clb(json);
    }, "json");
}

E.delete_keyval = function(cap, key, val, clb) {
    if (clb == undefined)
        clb = function(json){
            console.log("post", json);
        }
    
    secret = cookies.get_cookie().pseudonyms[E.agent.id];
    if (secret == undefined) {
        clb({error:"Not allowed to change "+E.agent.id+"'s profile."});
        return false;
    }
    data = JSON.stringify([[key, val]]);
    $.ajax({
        type: "DELETE",
        url: E.agent.url+"/"+cap,
        data: {data:data, secret:secret},
        success: clb,
        dataType: "json",
    });
}


E.populate_map = function(obj) {
    for (agent in obj) {
        exists = mapman.validateMarker(agent);
        if (!exists) {
            lat = obj[agent].lat;
            lon = obj[agent].lon;
            if (lat && lon) {
                var latlng = new google.maps.LatLng(lat, lon);
                mapman.addMarker(agent, latlng);
            }
        }
    }
    
    mapman.hideInvalidMarkers();
    
    if (E.reset_map_bounds) {
        //  Create a new viewpoint bound
        var bounds = new google.maps.LatLngBounds();
        //  Go through each...
        for (aid in mapman.markers) {
            bounds.extend(mapman.markers[aid].position);
        }
        
        if (Object.size(mapman.markers)) {
            //  Fit these bounds to the map
            mapman.map.fitBounds(bounds);
            zoom = mapman.map.getZoom();
            if (mapman.map.getZoom() > 16)
                mapman.map.setZoom(16);
        } else {
//             latlng = new google.maps.LatLng(42.360367, -71.087294);
//             mapman.map.setCenter(latlng);
        }
        E.reset_map_bounds = false;
    }
}

E.set_matches = function(stop, nonce) {
    if (nonce == undefined) {  
        stop = parseInt($("#matches").attr("curpos"));
    } else {
        $("#matches").attr("curpos", stop);
        $("title").html("Brin.gy ("+stop+")");
    }
    
    start = parseInt($("#matches").html());
    step = 1;
    
    if (Math.abs(start-stop) > 10) { step = 10 }
    if (Math.abs(start-stop) > 100) { step = 100 }
    if (Math.abs(start-stop) > 1000) { step = 1000 }
    if (start > stop) {
        $("#matches").html(start-step);
        setTimeout(E.set_matches, 20);
    }
    if (start < stop) {
        $("#matches").html(start+step);
        setTimeout(E.set_matches, 20);
    }
}

E.toggle_filter = function(action, cap, key, val){
    attr = {cap:cap,key:key,val:val,type:"valfilter"};
    if (action == "remove") {
        query = ".filter[cap='"+cap+"'][key='"+key+"']";
        if (val != undefined)
            query += "[val='"+val+"']";
        else 
            query += "[type='keyfilter']";
            
        $(query).remove();
        if ("removed", $(".filter").length == 0)
            $("#clear-filters-btn").hide();
        return true;
    }
    
    $("#clear-filters-btn").show();
    
    valstr = "<span class='highlight'>"+val+"</span>";
    if (val == undefined) {
        attr['type'] = "keyfilter";
        valstr = "anything";
    }
    
    closebtn = $("<a href='#'>Ã—</a>").addClass("closebtn").attr(attr);
    closebtn.click(function(){
        cap = $(this).attr("cap");
        key = $(this).attr("key");
        val = $(this).attr("val");
        query = "[cap='"+cap+"'][key='"+key+"']";
        if (val == undefined)
            query += "[type='keypart']";
        else
            query += "[val='"+val+"'][type='valpart']";
        $(query).click();
        return false;
    });
    title = "<span class='highlight'>"+key+"</span> is "+valstr;
    filter = $("<p></p>").append(title).append(closebtn).addClass("filter");
    filter.attr(attr);
    $("#filters").append(filter);
}

E.handle_key_click = function(){
    cap = $(this).attr("cap");
    key = $(this).attr("key");
    
    pressed = $(this).hasClass("pressed");
    attr_manager.sdata[cap][key].selected = !pressed;
    if (pressed) {
        $(this).removeClass("pressed");
        E.toggle_filter("remove", cap, key);
    } else {
        $(this).addClass("pressed");
        $(this).siblings("div").children().children().removeClass("pressed");
        for (val in attr_manager.sdata[cap][key].values) {
            attr_manager.sdata[cap][key].values[val].selected = false;
            E.toggle_filter("remove", cap, key, val);
        }
        E.toggle_filter("add", cap, key);
    }
    E.poll_matches(cap);
    E.reset_map_bounds = true;
    return false;
}

E.handle_val_click = function(){
    cap = $(this).attr("cap");
    key = $(this).attr("key");
    val = $(this).attr("val");
    
    pressed = $(this).hasClass("pressed");
    attr_manager.sdata[cap][key].values[val].selected = !pressed;
    if (pressed) {
        $(this).removeClass("pressed");
        E.toggle_filter("remove", cap, key, val);
    } else {
        $(this).addClass("pressed");
        $(this).parent().parent().siblings("a").removeClass("pressed");
        attr_manager.sdata[cap][key].selected = false;
        E.toggle_filter("remove", cap, key);
        E.toggle_filter("add", cap, key, val);
    }
    E.poll_matches(cap);
    E.reset_map_bounds = true;
    return false;
}

E.get_geocode = function(latlng, clb) {
    geogy.geocoder.geocode({'latLng': latlng}, function(results, status) {
        lat = results[0].geometry.location.lat();
        lon = results[0].geometry.location.lng();
        val = JSON.stringify({lat:""+lat,lon:""+lon});
        
        if (status == google.maps.GeocoderStatus.OK) {
            key = "my location";
            formatted = results[0].formatted_address;
            console.log('formatted address:', formatted, key);
            
            attr_manager.sdata.location[key].values[val] = {
                cnt:0, 
                selected:false,
                display:true,
                haveit:true, 
                matches:[],
                formatted: formatted,
            };
            
            counter = $("span.attr_counters[uitype=\"user_attribute\"][cap=\"location\"][key=\"my location\"]");
            counter.attr("val",val);
            counter.parent().attr("val",val);
        } else {
            alert("Geocoder failed due to: " + status);
        }
        if (formatted.length > E.formatted_length)
            formatted = formatted.substring(0,E.formatted_length-3)+"...";
            
        if (clb != undefined)
            clb(val, results, formatted);
    });
}

E.get_geolocation = function(clb) {
    
    location_clb = function(result) {
        key = "my location";
        modal = $("#modal-from-dom");
        clearTimeout(E.modal_timer);
        modal.modal("hide");
        attr_manager.sdata.location[key].values = {};
        
        latlng = new google.maps.LatLng(result.lat, result.lon);
        E.get_geocode(latlng, clb);
        E.populate_map(result);
    }
    
    geogy.init(location_clb);
    show_modal = function() {
        modal = $("#modal-from-dom");
        modal.modal({backdrop:"static", show:true, keyboard:true});
        
        $("#modal-cancel-btn").click(function(){
            modal.bind('hidden', function(){
                console.log("going to",E.website_url+"/manage/asdf");
                console.log("should go to", window.location);
//                     location.replace(E.website_url+"/manage/asdf");
            });
            modal.modal("hide");
        });
    }
    E.modal_timer = setTimeout(show_modal, 500);
}

E.complete_toggle_handle = function(cap, key, val, button) {
    haveit = attr_manager.sdata[cap][key].values[val].haveit;
    if (haveit) {
        E.post_keyval(cap, key, val, function(json){
            if (json.error) {
                alert(json.error);
                attr_manager.sdata[cap][key].values[val].haveit = !haveit;
                return false;
            }
            button.html("\u2713").popover("hide").css("background-color","");
            
            $("pill[key=\""+key+"\"]").attr("me","true");
            $("div.valcontainer[cap=\""+cap+"\"][key=\""+key+"\"][val=\""+val+"\"]").attr("me","true");
            
            confirmation = $(".confirmation").html("added to your profile!");
            confirmation.addClass("success").removeClass("important").show();
            confirmation.offset(button.offset());
            
            confirmation.animate({"left":"+=30px","top":"-=50px"}, "slow", function(){ 
                $(this).animate({"left":"+=0px"}, function(){
                    $(this).hide();
                });
            });
        });
    } else {
        E.delete_keyval(cap, key, val, function(json){
            if (json.error) {
                alert(json.error);
                attr_manager.sdata[cap][key].values[val].haveit = !haveit;
                return false;
            }
            button.html("\u00A0").popover("hide").css("background-color","");
            
            $("pill[key=\""+key+"\"]").attr("me","");
            $("div.valcontainer[cap=\""+cap+"\"][key=\""+key+"\"][val=\""+val+"\"]").attr("me","");
            
            confirmation = $(".confirmation").html("removed");
            confirmation.addClass("important").removeClass("success").show();
            confirmation.offset(button.offset());
            
            confirmation.animate({"left":"+=30px","top":"-=50px"}, "slow", function(){ 
                $(this).hide();
            });
        });
    }
}

E.handle_userattr_toggle =function(){
    var cap = $(this).attr("cap");
    var key = $(this).attr("key");
    var val = $(this).attr("val");
    button = $(this);
    
    haveit = attr_manager.sdata[cap][key].values[val].haveit;
    attr_manager.sdata[cap][key].values[val].haveit = !haveit;
    if (cap == "location") {
        if (haveit == false) {
            clb = function(val, results, formatted) {
                button.attr("val", val);
                button.siblings().children("span.value").html(formatted);
                E.complete_toggle_handle(cap, key, val, button);
            };
            E.get_geolocation(clb);
        } else {
            button.siblings().children("span.value").html("");
            E.complete_toggle_handle(cap, key, val, button);
        }
    } else {
        E.complete_toggle_handle(cap, key, val, button);
    }
    return false;
}

E.handle_userattr_hover_in = function(){
    cap = $(this).attr("cap");
    key = $(this).attr("key");
    val = $(this).attr("val");
    
    color = "green";
    text = "+";
    if (attr_manager.sdata[cap][key].values[val].haveit) {
        color = "red";
        text = "-";
    }
    
    $(this).html(text).css("background-color",color);
};

E.handle_userattr_hover_out = function(){
    cap = $(this).attr("cap");
    key = $(this).attr("key");
    val = $(this).attr("val");
    
    text = "\u00A0";
//     console.log("hoverout:",cap,key,val,attr_manager.sdata[cap][key].values[val].haveit);
    if (attr_manager.sdata[cap][key].values[val].haveit) {
        text = "\u2713";
    }
    $(this).html(text).css("background-color","");
}

E.generate_key_entry = function(capname, attr) {
    // attr_counters class is used to group and iterate through all attribute counters
    count = $("<span></span>").addClass("count attr_counters");
    count.html(attr_manager.sdata[capname][attr].cnt);
    count.attr({uitype:"sat_attribute", cap:capname, key:attr});
    
    attribute = $("<span></span>").html(attr);
    pair = {cap:capname, key:attr, type:"keypart"};
    var keypart = $("<a href='#'></a>").append(attribute);
    keypart.append(count).attr(pair);
    keypart.click(E.handle_key_click);
    
    if (attr_manager.sdata[capname][attr].selected)
        keypart.addClass("pressed");
        
    return keypart;
}

E.generate_val_entry = function(capname, attr, val) {
    
    count = $("<span></span>").addClass("count attr_counters");
    count.html(attr_manager.sdata[capname][attr].values[val].cnt);
    count.attr({
        uitype:"user_attribute", cap:capname, key:attr, val:val,
    });
    count.addClass("attr_counters").attr(attr);
    
    formatted = val;
    
    address = "";
    if (capname=="location" && attr=="my location") {
        address = attr_manager.sdata[capname][attr].values[val].formatted;
        if (address == undefined)
            formatted = "";
        else
            formatted = address;
    }
    
    if (formatted.length > E.formatted_length)
        formatted = formatted.substring(0,E.formatted_length-3)+"...";
        
    value = $("<span class='value'></span>").html(formatted);
    
    pair = {cap:capname, key:attr, val:val, address:address};
    value_pill = $("<a href='#'></a>").attr(pair).click(E.handle_val_click);
    value_pill.attr("type","valpart");
    value_pill.append(count).append(value)
    value_pill.twipsy({placement:"below", offset:5, title:function(){
        cap = $(this).attr("cap");
        val = $(this).attr("val");
        address = $(this).attr("address");
        if (val.length > 10)
            if (cap == "location")
                return address
            else
                return val;
        return "";
    }});
    
    if (attr_manager.sdata[capname][attr].values[val].selected)
        value_pill.addClass("pressed");
    
    // ****** add_btn ****** add_btn ****** add_btn ******
    add_btn = $("<span class='add_btn' title='the title' data-content='the content'></span>").attr(pair);
    
    add_btn.click(E.handle_userattr_toggle);
    
    // ****** HOVER ****** HOVER ****** HOVER ******
    add_btn.hover(E.handle_userattr_hover_in, E.handle_userattr_hover_out);
    
    text = "\u00A0";
    if (attr_manager.sdata[capname][attr].values[val].haveit) {
        text = "\u2713";
    }
    
    // ****** POPOVER ****** POPOVER ****** POPOVER ******
    add_btn.html(text).popover({title:function(){
        return $(this).attr("key")+": "+$(this).attr("val");
    }, content:function(){
        cap = $(this).attr("cap");
        key = $(this).attr("key");
        val = $(this).attr("val");
        
        if (attr_manager.sdata[cap][key].values[val].haveit)
            return "Remove this from your profile.";
        else
            return "Add this to your "+cap;
    }, offset:15});
    
    value_container = $("<div class='valcontainer'></div>");
    value_container.append(value_pill).append(add_btn);
    pair["new"] = attr_manager.sdata[capname][attr].values[val].new;
    pair["me"] = attr_manager.sdata[capname][attr].values[val].haveit;
    value_container.attr(pair);
    return value_container;
}

E.generate_val_entry_editor = function(attr) {
    editor = $("<form class='editor' title='new value' data-content='the content'></form>");
    editbox = $("<input type='text' class='span2' class='editbox' />");
    editor.attr({key:attr});
    editbox.attr({key:attr, cap:"profile"}).attr("tabindex", E.tabindex);
    E.tabindex++;
    editbox.popover({title:function(){
        return $(this).attr("key");
    }, content:function(){
        key = $(this).attr("key");
        val = $(this).attr("val");
        if (val) {
            test = (val in attr_manager.sdata.profile[key].values);
            html = $("<div>"+val+":"+test+"</div>");
            if (test)
                html.html(val+": already exists").addClass("error");
            else
                html.html('press enter to save "<b>'+val+'</b>"');
            return html;
        }
        return 'Type new "'+$(this).attr("key")+'" entry';
    }, offset:15, html:true, animate:false, trigger:"focus"});
    editbox.keydown(function(obj){
        if (obj.keyCode == 8)
            val = $(this).val().substr(0,$(this).val().length-1);
        else if (obj.keyCode != 13)
            val = $(this).val()+String.fromCharCode(obj.keyCode);
        else
            val = "";
            
//         if (obj.metaKey || obj.altKey || obj.ctrlKey)
//             return false;
            
        val = val.toLowerCase();
        $(this).attr("val",val);
        $(this).popover('show');
    });
    editor.submit(function(){
        cap = "profile";
        key = $(this).attr("key");
        val = $(this).children("input").val();
        console.log("submitting", cap, key, val);
        test = (val in attr_manager.sdata.profile[key].values);
        if (!test) {
            attr_manager.sdata[cap][key].values[val] = {
                cnt:0, 
                selected:0,
                display:true,
                haveit:true, 
                matches:{},
                new:false,
            };
            
//             console.log(attr_manager.sdata.profile.name);
            
            value_container = E.generate_val_entry("profile", key, val);
            $(this).before(value_container);
            that = this;
            E.post_keyval(cap, key, val, function(){
                console.log("added", key, val);
                $(that).children("input").val("");
            });
        }
        return false;
    });
    editor.html(editbox);
    return editor;
}

E.populate_attrs = function(useEditor) {
    
    if (useEditor == undefined)
        useEditor = true;
        
    $("#choices").empty();
    for (capname in attr_manager.sdata) {

        app = $("<div></div>").addClass("clear");
        $("#choices").append(app).addClass("");
        for (attr in attr_manager.sdata[capname]) {
            
            if (attr_manager.sdata[capname][attr].display == false)
                continue;
            
            keypart = E.generate_key_entry(capname, attr);
            valpart = $("<div class='valpart'></div>");
            
            for (val in attr_manager.sdata[capname][attr].values) {
                if (attr_manager.sdata[capname][attr].values[val].display == false)
                    continue;
                value_container = E.generate_val_entry(capname, attr, val);
                valpart.append(value_container);
            }
            
            if (capname=="profile" && useEditor==true) {
                editor = E.generate_val_entry_editor(attr);
                valpart.append(editor);
            }
            
            pill = $("<pill></pill>").append(keypart).append(valpart).attr("key",attr);
            
            if (capname == "location") {
                pill.addClass("location");
                valpart.children("div").css("height",50);
            }
            
            pair = {new:false, me:false};
            for (val in attr_manager.sdata[capname][attr].values) {
                if (attr_manager.sdata[capname][attr].values[val].new == true)
                    pair.new = true;
                if (attr_manager.sdata[capname][attr].values[val].haveit)
                    pair.me = true;
            }
            pill.attr(pair);
            
            app.append(pill);
        }
    }
}


//////////////////////////////////////////////////

E.construct_result_enty = function(agent) {
    picture = "http://pldb.media.mit.edu/research/images/nophoto.gif";
    if ("picture" in attr_manager.cache[agent].profile)
        for (p in attr_manager.cache[agent].profile.picture)
            picture = p;
            
    pic = $("<img width=20 style='float:left; clear:left;' />").attr("src",picture);
    username = $("<span style='margin-left:5px'></span>").html(agent);
    entry = $("<a href='#'></a>").append(pic).append(username);
    entry.attr({agent:agent});
    entry.click(function(){
        agent = $(this).attr("agent");
        selected = $(this).hasClass("pressed");
        
        if (selected) {
            $(this).removeClass("pressed");
            attr_manager.show_keyvals();
            $("#userinfo").slideUp();
            
            useEditor = true;
        } else {
            $('#results a').removeClass("pressed");
            $(this).addClass("pressed");
            
            $("#userinfo").html("User: "+agent).slideDown();
            
            profile = attr_manager.cache[agent].profile;
            
            attr_manager.hide_keyvals();
            
            for (k in profile) {
                if (attr_manager.sdata.profile[k])
                    attr_manager.sdata.profile[k].display = true;
                else
                    continue;
                
                detail = $("<div></div>").html(k+":");
                for (val in profile[k]) {
                    attr_manager.sdata.profile[k].values[val].display = true;
                    detail.append(", "+val);
                }
            }
            useEditor = false;
        }

        E.populate_attrs(useEditor);
        
        if (E.location_engaged)
            mapman.highlightMarker(agent);
        
        return false;
    });
    return entry;
}

E.get_multi_profile = function(agents) {
    $.getJSON(E.agent.baseurl+"/batch_profile", {data:JSON.stringify(agents)}, function(json){
        for (agent in json.profiles) {
            
            profile = {};
            for (i in json.profiles[agent].data) {
                key = json.profiles[agent].data[i].key;
                val = json.profiles[agent].data[i].val;
                if (profile[key] == undefined)
                    profile[key] = {};
                profile[key][val] = 1;
            }
            
            if (attr_manager.cache[agent] == undefined)
                attr_manager.cache[agent] = {};
            attr_manager.cache[agent].profile = profile;
        }

    
        $.getJSON(E.agent.baseurl+"/batch_location", {data:JSON.stringify(agents)}, function(json){
            
            for (agent in json.locations) {
                locobj = json.locations[agent];
                
                if (attr_manager.cache[agent] == undefined)
                    attr_manager.cache[agent] = {};
                attr_manager.cache[agent].location = locobj;
            }
            E.populate_map(json.locations);
        });
        
        agentsobj = {};
        for (i in agents) {
            agent = agents[i];
            agentsobj[agent] = 1;
            if (E.previous_intersection[agent]==undefined) {
                entry = E.construct_result_enty(agent);
                $("#results").append(entry);
                E.previous_intersection[agent] = 1;
            }
        }
        
        for (agent in E.previous_intersection) {
            if (agentsobj[agent]==undefined) {
                $('a[agent="'+agent+'"]').slideUp().remove();
                delete E.previous_intersection[agent];
            }
        }
//         $("#cart-btn").show();
    });
}



E.poll_matches = function(capname) {
    btnclicked = 0;
    query = [];
    
    for (cap in attr_manager.sdata)
        for (key in attr_manager.sdata[cap]) {
            query.push([cap, key, ""]);
            for (val in attr_manager.sdata[cap][key].values) {
                query.push([cap, key, val]);
            }
        }
    
    data = JSON.stringify(query);
    
    $.post(E.satellite.url+"/multimatch", {data:data}, function(json){
        E.monitor.user_matches.by_keyval = {};
        
        for (i in json.matches) {
            
            match = json.matches[i];
            
            cap = match[0];
            key = match[1];
            val = match[2];
            cnt = match[3];
            matches = match[4];
            
            if (val.length > 0) {
                if (attr_manager.sdata[cap][key].values[val]==undefined)
                    console.log("***", cap, key, val, attr_manager.sdata);
                attr_manager.sdata[cap][key].values[val].cnt = cnt;
                attr_manager.sdata[cap][key].values[val].matches = matches;
            } else {
                if (attr_manager.sdata[cap][key].cnt==undefined)
                    console.log("***", cap, key, attr_manager.sdata);
                attr_manager.sdata[cap][key].cnt = cnt;
                attr_manager.sdata[cap][key].matches = matches;
            }
        }
        
        test_intersection = {};
        target_count = 0
        
        E.location_engaged = false;
        
        E.match_criteria = [];
        for (cap in attr_manager.sdata) {
            for (key in attr_manager.sdata[cap]) {
                for (val in attr_manager.sdata[cap][key].values) {
                    if (attr_manager.sdata[cap][key].values[val].selected) {
                        if (cap == "location")
                            E.location_engaged = true;
                        E.match_criteria.push([cap, key, val]);
                        for (i in attr_manager.sdata[cap][key].values[val].matches) {
                            agent = attr_manager.sdata[cap][key].values[val].matches[i];
                            if (test_intersection[agent] == undefined)
                                test_intersection[agent] = 0;
                            test_intersection[agent] += 1;
                        }
                        target_count += 1;
                    }
                }
                if (attr_manager.sdata[cap][key].selected) {
                    if (cap == "location")
                        E.location_engaged = true;
                    E.match_criteria.push([cap, key, ""]);
                    for (i in attr_manager.sdata[cap][key].matches) {
                        agent = attr_manager.sdata[cap][key].matches[i];
                        if (test_intersection[agent] == undefined)
                            test_intersection[agent] = 0;
                        test_intersection[agent] += 1;
                    }
                    target_count += 1;
                }
            }
        }

        mapman.invalidateMarkers();
        if (capname != undefined) {
            E.update_monitor();
        }
        
        intersection = [];
        for (match in test_intersection)
            if (test_intersection[match] == target_count) {
//                 if (match != E.agent.id)
                    intersection.push(match);
            }
        
        
        if (intersection.length > 0) {
            E.get_multi_profile(intersection);
        } else {
            $("#cart-btn").hide();
            $("#results").empty();
            mapman.deleteOverlays();
            E.previous_intersection = {};
        }
        
        
        E.monitor.user_matches.intersection = intersection;
        E.set_matches(Object.size(intersection), "external");
        
        $(".attr_counters").each(function(){
            if ($(this).attr("uitype") == "sat_attribute") {
                cap = $(this).attr("cap");
                key = $(this).attr("key");
                $(this).html(attr_manager.sdata[cap][key].cnt);
            }
            
            if ($(this).attr("uitype") == "user_attribute") {
                cap = $(this).attr("cap");
                key = $(this).attr("key");
                val = $(this).attr("val");
                
                if (attr_manager.sdata[cap][key] == undefined ||
                    attr_manager.sdata[cap][key].values[val] == undefined) {
                    $(this).remove();
                    cnt = 0;
                } else {
                    cnt = attr_manager.sdata[cap][key].values[val].cnt;
                    $(this).html(cnt);
                }
            }
        });
    }, "json");
}




E.fetch_initial_info = function(clb) {
    targetcount = 2;
    count = 0;
    finished = function() {
        count++;
        if (count==targetcount) {
            clb();
        }
    }
    
    $.getJSON(E.agent.url+"/profile/visited", function(json){
        E.fetch_profile(json.data, finished);
        E.fetch_location(finished);
    });
}

E.fetch_profile = function(visited, clb) {
    console.log("visited", visited);
    if (E.last_fetched.length)
        console.log("continuing from", E.last_fetched);
    
    data = JSON.stringify({with_values:1, user:E.agent.id});
    
    $.getJSON(E.satellite.url+"/profile/fetch/"+E.last_fetched, {data:data}, function(json){
        for (i in json.matches) {
            attribute = json.matches[i].key;
            attr_manager.add_sdata("profile", attribute, 0);
            for (j in json.matches[i].values) {
                val = json.matches[i].values[j].val;
                cnt = json.matches[i].values[j].score;
                haveit = (json.matches[i].values[j].userhasit==1);
                
                newval = true;
                if (attribute in visited && val in visited[attribute])
                    newval = false
//                 if (newval)
//                     console.log("new val:", attribute, val);
                    
                attr_manager.sdata.profile[attribute].values[val] = {
                    cnt:cnt, 
                    selected:0,
                    display:true,
                    haveit:haveit, 
                    matches:{},
                    new:newval,
                };
            }
            E.last_fetched = attribute;
        }
        clb();
        console.log("finish  profile");
    });
}

E.fetch_location = function(clb) {
    // I should get all possible keys from the satellite,
    // let's fix it to "my location" for now.
    key = "my location";
    $.getJSON(E.satellite.url+"/location/fetch/"+E.agent.id+"/"+key, function(json){
        val = {lat:json.lat, lon:json.lon};
        valstr = JSON.stringify(val);
        key = "my location";
        attr_manager.add_sdata("location", key, 0);
        
//         console.log("checking", E.agent.id, cookies.get_cookie().pseudonyms, json.lat, json.lon);
        if (json.lat.length && json.lon.length) {
            
            geoclb = function(val, results, formatted) {
                console.log("geoclb:", val, results, formatted);
                
                cap = "location";
                key = "my location";
                oldval = {lat:""+json.lat,lon:""+json.lon};
                oldval = JSON.stringify(oldval);
                
                
                E.post_keyval(cap, key, val, function(json){
                    console.log("saving new location:", json.error);
                });
                clb();
                console.log("finish  location");
            }
            
            if (E.agent.id in cookies.get_cookie().pseudonyms) {
                E.get_geolocation(geoclb);
            } else {
                latlng = new google.maps.LatLng(json.lat, json.lon);
                E.get_geocode(latlng, function(){
                    clb();
                    console.log("finish  location");
                });
            }
        } else {
            attr_manager.sdata.location[key].values[valstr] = {
                cnt:json.count, 
                selected:0, 
                display:true, 
                haveit:false, 
                matches:json.matches,
            };
            clb();
            console.log("finish  location");
        }
    });
}

E.update_monitor = function() {
//     console.log(E.match_criteria);
    if (window.location.search == "?control") {
        data = JSON.stringify(E.match_criteria);
        $.post(E.agent.baseurl+"/controller", {data:data, controller:E.agent.id}, function(json){
            console.log("controller post:", json);
        }, "json");
    };
    return false;
}


var show_delete_modal = function() {
    modal = $("#delete-confirmation-modal");
    modal.modal({backdrop:"static", show:true, keyboard:true});
    
    $("#delete-cancel-btn").click(function(){
        modal.modal("hide");
    });
    $("#delete-delete-btn").click(function(){
        that = this;
        secret = cookies.get_cookie().pseudonyms[E.agent.id];
        console.log("deleting", E.agent.url, secret);
        $.ajax({
            url: E.agent.url,
            type: "DELETE",
            data: {secret:secret},
            success: function(json) {
                if (json.error.length) {
                    $(that).parent().parent().modal("hide");
                    alert(json.error);
                } else {
                    cookies.del_cookie(E.agent.id);
                    location.replace(E.website_url);
                }
            },
            dataType: "json",
        });
    });
}

var show_getlocation_modal = function() {
    modal = $("#get-location-modal");
    modal.modal({backdrop:"static", show:true, keyboard:true});
    
    $("#location-cancel-btn").click(function(){
        modal.modal("hide");
    });
    $("#location-ok-btn").click(function(){
        geoclb = function(val, results, formatted) {
            console.log("geoclb:", val, results, formatted);
            cap = "location";
            key = "my location";
            button = $("span.add_btn[cap='"+cap+"'][key='"+key+"']");
            button.attr("val", val);
            button.siblings().children("span.value").html(formatted);
            E.complete_toggle_handle(cap, key, val, button);
        }
        
        E.get_geolocation(geoclb);
        modal.modal("hide");
    });
}

E.resize_overflow_divs = function(){
    offset = $("#choices").offset();
    dheight = $(document).height();
    $("#choices").height(dheight - offset.top - 40);
    $("#results").height(dheight - offset.top + 20);// - 70);
    $("#map_canvas").height(dheight - offset.top + 20);
}

E.get_val_input_boxes = function() {
    return $("input[cap=\"profile\"]");
}

E.nav_search = function(){
    $("#searchbox").show();
    $("#add-key-div").hide();
    $("#searchinput").focus();
    
    $("#message").hide();
    $("div.valcontainer").show();
    $("pill").show();
    $("#choices div.help-block").remove();
    E.get_val_input_boxes().show();
}
E.nav_new = function(){
    $("#searchbox").hide();
    $("#add-key-div").hide();
    
    $("div.valcontainer").show();
    $("pill").show();
    $("div.valcontainer[new!=\"true\"]").hide();
    $("pill[new!=\"true\"]").hide();
    
    $("#message").hide();
    if ($("pill[new=\"true\"]").length == 0) {
        alert = $("<div class='alert-message warning fade in' data-alert='alert'><a class='close' href='#'>&times;</a><p>Nothing new yet.<br>Why not add something new about you?</p></div>")
        alert.alert();
        $("#message").show().html(alert);
    }
    
    E.get_val_input_boxes().hide();
    E.post_visited_keyval();
}
E.nav_me = function(){
    $("#searchbox").hide();
    $("#add-key-div").show();
    $("#new-key-input").focus();
    
    $("#choices div.help-block").remove();
    $("div.valcontainer").show();
    $("pill").show();
    $("div.valcontainer[me!=\"true\"]").hide();
    $("pill[me!=\"true\"]").hide();
    
    $("#message").hide();
    if ($("pill:visible").length == 0) {
        alert = $("<div class='alert-message warning fade in' data-alert='alert'><a class='close' href='#'>&times;</a><p>Your profile is empty.<br>Try typing an attribute below, or go to the \"search\" tab to add from existing ones.</p></div>")
        alert.alert();
        $("#message").show().html(alert);
    }
    
    E.get_val_input_boxes().show();
}

//////////////////////////////////////////////////
////////////////     ON READY

$(document).ready(function()
{
    clb = E.populate_attrs;
    E.fetch_initial_info(clb);
    
    
    $("#match_btn").click(function(){
        return false;
    });
    
    $("#clear-filters-btn").click(function(){
        $(".filter").each(function(){
            $(this).children("a.closebtn").click();
        });
        return false;
    });
    $("#search-clear-btn").click(function(){
        $("#searchinput").val("").keyup().focus();
        return false;
    });
    
    
    setInterval(E.poll_matches, 2000); 
    
    $("#delete_btn").show().click(show_delete_modal);
    $("#pseudonym").show();
    
    $("nav a").click(function (){
        $("nav a").removeClass("selected");
        $(this).addClass("selected");
        if ($(this).html() == "search") E.nav_search();
        if ($(this).html() == "new") E.nav_new();
        if ($(this).html() == "me") E.nav_me();
        return false;
    });
    
    E.resize_overflow_divs();
    
    mapman.initialize();
    
    E.tabindex = 2;
    $("#searchinput").attr("tabindex", 1).focus().keydown(function(obj){
        if (obj.metaKey || obj.altKey || obj.ctrlKey) {
//             console.log(obj.keyCode);
//             return false;
        }
    }).keyup(function(obj) {
//         attr_manager.deselect_keyvals();
        
        text = $(this).val();
        attr_manager.show_keyvals();
        if (text.length == 0)
            $("#search-clear-btn").hide();
        else
            $("#search-clear-btn").show();
            
        if (text.length == 1) {
            return true;
        }
        
        
        E.get_val_input_boxes().hide();
        
//         $(this).attr("key",text.toLowerCase());
//         $(this).popover("show");
        
        matches = text.split(' ');
        rexpr = "";
        for (i in matches) {
            if (matches[i].length == 0)
                continue;
            if (i>0)
                rexpr += "|";
            rexpr += matches[i];
        }
        re = new RegExp(rexpr, 'i');
        
        for (cap in attr_manager.sdata)
            for (key in attr_manager.sdata[cap]) {
                if (key.match(re)) {
                    attr_manager.sdata[cap][key].display = true;
                    
                } else {
                    no_match = true;
                
                    for (val in attr_manager.sdata[cap][key].values) {
                        if (val.match(re)) {
                            attr_manager.sdata[cap][key].values[val].display = true;
                            no_match = false;
                        } else {
                            attr_manager.sdata[cap][key].values[val].display = false;
                        } 
                    }
                    
                    if (no_match)
                        attr_manager.sdata[cap][key].display = false;
                }
            }
        E.populate_attrs();
    });
    
    $("#new-key-input").attr("tabindex", 1).keyup(function(obj) {
        text = $(this).val();
        attr_manager.show_keyvals();
            
        if (text.length == 1) {
            return true;
        }
        $(this).attr("key",text.toLowerCase());
        $(this).popover("show");
        
        matches = text.split(' ');
        rexpr = "";
        for (i in matches) {
            if (matches[i].length == 0)
                continue;
            if (i>0)
                rexpr += "|";
            rexpr += matches[i];
        }
        re = new RegExp(rexpr, 'i');
        
        for (cap in attr_manager.sdata)
            for (key in attr_manager.sdata[cap]) {
                if (key.match(re)) {
                    attr_manager.sdata[cap][key].display = true;
                    
                } else {
                    no_match = true;
                
                    for (val in attr_manager.sdata[cap][key].values) {
                        if (val.match(re)) {
                            attr_manager.sdata[cap][key].values[val].display = true;
                            no_match = false;
                        } else {
                            attr_manager.sdata[cap][key].values[val].display = false;
                        } 
                    }
                    
                    if (no_match)
                        attr_manager.sdata[cap][key].display = false;
                }
            }
        E.populate_attrs();
    }).popover({content:function(){
        key = $("#searchinput").attr("key");
        html = $("<div></div>");
        
        if (key == undefined || key.length == 0)
            return "Type to add new attribute";
            
        if (key in attr_manager.sdata.profile) {
            html.html(key+": already exists").addClass("error");
        } else
            html.html('press enter to add "<b>'+key+'</b>"');
            
        return html;
    }, offset:15, html:true, animate:false, trigger:"focus"});
    
    $("#add-key-div").submit(function(){
        searchinput = $(this).children("input");
        newkey = searchinput.val();
        if (newkey in attr_manager.sdata.profile) {
            searchinput.popover("hide");
            $(".editor").children().focus();
        } else {
            searchinput.popover("hide").val("").attr("key","");
            attr_manager.show_keyvals();
            E.populate_attrs(true);
            
            cap = "profile";
            attr_manager.add_sdata(cap, newkey, 0);
            
            keypart = E.generate_key_entry(cap, newkey);
            editor = E.generate_val_entry_editor(newkey);
            valpart = $("<div class='valpart'></div>").append(editor);
            
            pill = $("<pill></pill>").append(keypart).append(valpart);
            $("#choices").children("div:nth-child(2)").prepend(pill);
            editor.children("input").focus();
        }
        return false;
    });
    
    
    
    $("#searchbox").submit(function(){
        return false;
        
        searchinput = $(this).children("input");
        newkey = searchinput.val();
        if (newkey in attr_manager.sdata.profile) {
            $("#searchinput").popover("hide");
            $(".editor").children().focus();
        } else {
            searchinput.popover("hide").val("").attr("key","");
            attr_manager.show_keyvals();
            E.populate_attrs(true);
            
            cap = "profile";
            attr_manager.add_sdata(cap, newkey, 0);
            
            keypart = E.generate_key_entry(cap, newkey);
            editor = E.generate_val_entry_editor(newkey);
            valpart = $("<div class='valpart'></div>").append(editor);
            
            pill = $("<pill></pill>").append(keypart).append(valpart);
            $("#choices").children("div:first-child").prepend(pill);
            editor.children("input").focus();
        }
        return false;
    });
    
    
    if (window.location.hash.startsWith("#tour")) {
        Tour.do_tour(0);
    }
//     if (window.location.hash.startsWith("#search")) {
//         $("nav a:nth-child(1)").click();
//     }
//     if (window.location.hash.startsWith("#new")) {
//         $("nav a:nth-child(2)").click();
//     }
//     if (window.location.hash.startsWith("#me")) {
//         $("nav a:nth-child(3)").click();
//     }
    
    $("#cart-btn a").click(function(){
        console.log(E.previous_intersection);
        return false;
    });
    $("#tourBtn").show().click(function(){
        attr_manager.deselect_keyvals();
//         E.populate_attrs();
        Tour.do_tour(0);
        return false;
    });
    
    $(document).bind('keydown', function(event){
        if (event.keyCode == 27 && Tour.inTour == true)
            Tour.close_tour();
    });
    
    $("#coverclosebtn").click(Tour.close_tour);
    $("#covernextbtn").click(function(){
        index = parseInt($(this).attr("index"));
        if (index == Tour.tourSlides.length-1) {
            Tour.close_tour();
            have_location = attr_manager.get_location();
            if (have_location == null)
                show_getlocation_modal();
        } else {
            Tour.do_tour(index+1);
        }
        return false;
    });
    $("#coverbackbtn").click(function(){
        index = parseInt($(this).attr("index"));
        if (index > 0)
            Tour.do_tour(index-1);
        return false;
    });
});


</script>
{% end %}
{% block body %}

<div id="left-panel" class="span6">
    <nav class="">
        <a href="#" class="selected">search</a>
        <a href="#" class="">new</a>
        <a href="#" class="">me</a>
    </nav>
    <form id="searchbox">
        <div class="help-block">search for attribute</div>
        <input type="text" id="searchinput" class="" />
        <a href='#' class="closebtn" id="search-clear-btn">Ã—</a>
    </form>
    <div id="message"></div>
    <form id="add-key-div">
        <div class="help-block">type to add new attribute</div>
        <input type="text" id="new-key-input" title='add new attribute' data-content='press enter to add this attribute' />
    </form>
    
    <div id="userinfo"></div>
    <div id="choices"></div>
</div>
<div id="right-panel" class="">            
    <div id="results-container" class="span3">
        <div id="filters">
            <div id="clear-filters-btn" class="btn" style="width">clear filters</div>
        </div>
        <div id="results"></div>
        <div id="cart-btn" class="btn success">
            <img height=50 src='{{ static_url("images/website/cart.svg") }}' alt="" />
            <span class="description">add people to cart</span>
        </div>
    </div>
    <div id="map_canvas" class=""></div>
    <button id="match_btn" class="btn info">
        <div id="matches" curpos="0">0</div>
        <div id="matches_caption">people match</div>
    </button>
</div>


<div id="modal-from-dom" class="modal hide fade">
    <div class="modal-header">
        <a href="#" class="close">&times;</a>
        <h3>Current Location</h3>
    </div>
    <div class="modal-body">
        <p>To find others near you, please choose to share your location above.</p>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn danger" id="modal-cancel-btn">Cancel</a>
    </div>
</div>


<div id="delete-confirmation-modal" class="modal hide fade">
    <div class="modal-header">
        <a href="#" class="close">&times;</a>
        <h3>What?! Are you sure?</h3>
    </div>
    <div class="modal-body">
        <p>You understand that this is <b>not</b> Facebook,<br> if you delete this agent all associated data will <b>actually</b> be deleted ;)</p>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn danger" id="delete-delete-btn">Trash everything</a>
        <a href="#" class="btn primary" id="delete-cancel-btn">Cancel</a>
    </div>
</div>


<div id="get-location-modal" class="modal hide fade">
    <div class="modal-header">
        <a href="#" class="close">&times;</a>
        <h3>Location</h3>
    </div>
    <div class="modal-body">
        <p>Would you like to use your location to get more relevant results?</p>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn danger" id="location-cancel-btn">No</a>
        <a href="#" class="btn success" id="location-ok-btn">Yes</a>
    </div>
</div>


<div id="coverbanner" class="cover">
    <div id="covertext" class="cover">asdf</div>
    <a href="#" id="covernextbtn" class="btn success">Next</a>
    <a href="#" id="coverbackbtn" class="">Back</a>
    <a href="#" id="coverclosebtn" class="">x close</a>
</div>


<div id="covertop" class="cover"></div>
<div id="coverleft" class="cover"></div>
<div id="coverright" class="cover"></div>
<div id="coverbottom" class="cover"></div>
<div id="popup"></div>

<div class='confirmation label'></div>

{% end %}




